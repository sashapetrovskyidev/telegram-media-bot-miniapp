<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio Quest - Real Move</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; }
        canvas { display: block; }
    </style>
</head>
<body>
<script>
    let popup;

    function showNotice(scene, text) {
        if (popup) popup.destroy();
        popup = scene.add.text(scene.cameras.main.worldView.centerX, scene.cameras.main.worldView.centerY - 100, text, {
            fontSize: '40px', fill: '#fff', backgroundColor: '#e74c3c', padding: { x: 20, y: 10 }
        }).setOrigin(0.5).setDepth(2000).setScrollFactor(0); // Текст зафиксирован на экране
        
        scene.time.delayedCall(2000, () => { if (popup) popup.destroy(); });
    }

    // --- БАЗОВЫЙ КЛАСС КОМНАТЫ ---
    class BaseRoom extends Phaser.Scene {
        constructor(key) { super(key); }

        createRoom(bgKey, spawnX, spawnY) {
            // Рисуем фон без растягивания
            const bg = this.add.image(0, 0, bgKey).setOrigin(0, 0);
            
            // Настраиваем границы мира по размеру картинки
            this.physics.world.setBounds(0, 0, bg.width, bg.height);
            
            // Спавним героя
            this.player = this.physics.add.sprite(spawnX, spawnY, 'player');
            this.player.setScale(3); // Отрегулируй масштаб под размер комнаты
            this.player.setCollideWorldBounds(true);
            this.playerDirection = 'down';

            // Настройка камеры
            this.cameras.main.setBounds(0, 0, bg.width, bg.height);
            this.cameras.main.startFollow(this.player, true, 0.1, 0.1);
            this.cameras.main.setZoom(1); // Можно увеличить зум, если комната слишком большая

            // Анимации
            if (!this.anims.exists('walk-down')) {
                const dirs = ['down', 'left', 'right', 'up'];
                dirs.forEach((dir, i) => {
                    this.anims.create({
                        key: `walk-${dir}`,
                        frames: this.anims.generateFrameNumbers('player', { start: i * 4, end: i * 4 + 3 }),
                        frameRate: 10, repeat: -1
                    });
                    this.anims.create({ key: `idle-${dir}`, frames: [{ key: 'player', frame: i * 4 }], frameRate: 1 });
                });
            }

            this.input.on('pointerdown', (p) => {
                this.targetX = p.worldX;
                this.targetY = p.worldY;
                this.physics.moveTo(this.player, this.targetX, this.targetY, 400);
            });
        }

        updateHero() {
            const vel = this.player.body.velocity;
            if (vel.x !== 0 || vel.y !== 0) {
                const deg = Phaser.Math.RadToDeg(Math.atan2(vel.y, vel.x));
                if (deg > -45 && deg <= 45) { this.player.anims.play('walk-right', true); this.playerDirection = 'right'; }
                else if (deg > 45 && deg <= 135) { this.player.anims.play('walk-down', true); this.playerDirection = 'down'; }
                else if (deg > 135 || deg <= -135) { this.player.anims.play('walk-left', true); this.playerDirection = 'left'; }
                else { this.player.anims.play('walk-up', true); this.playerDirection = 'up'; }
            } else {
                this.player.anims.play('idle-' + this.playerDirection, true);
            }

            if (this.targetX && Phaser.Math.Distance.Between(this.player.x, this.player.y, this.targetX, this.targetY) < 10) {
                this.player.body.reset(this.player.x, this.player.y);
                this.targetX = null;
            }
        }
    }

    // --- ГОСТИНАЯ ---
    class MainScene extends BaseRoom {
        constructor() { super('MainScene'); }
        preload() {
            this.load.image('room1', 'room1.png');
            this.load.spritesheet('player', 'person_model.png', { frameWidth: 64, frameHeight: 64 });
        }
        create() {
            const spawnX = this.scene.settings.data.fromStudio ? 800 : 300;
            this.createRoom('room1', spawnX, 600); // Координаты спавна внутри большой картинки

            // Дверь (просто текст)
            this.door = this.add.rectangle(100, 300, 100, 200, 0x000, 0);
            this.physics.add.existing(this.door, true);
            this.physics.add.overlap(this.player, this.door, () => showNotice(this, "Нам сейчас не сюда"));

            // Зона перехода на ламинате (справа)
            const worldWidth = this.physics.world.bounds.width;
            const worldHeight = this.physics.world.bounds.height;
            this.trigger = this.add.rectangle(worldWidth - 50, worldHeight - 150, 100, 200, 0x000, 0);
            this.physics.add.existing(this.trigger, true);
            this.physics.add.overlap(this.player, this.trigger, () => this.scene.start('StudioScene', { fromMain: true }));
        }
        update() { this.updateHero(); }
    }

    // --- СТУДИЯ ---
    class StudioScene extends BaseRoom {
        constructor() { super('StudioScene'); }
        preload() { this.load.image('room2', 'room2.png'); }
        create() {
            const worldHeight = 800; // Примерная высота
            this.createRoom('room2', 150, 600);

            // Дверь (просто текст)
            this.door2 = this.add.rectangle(800, 300, 100, 200, 0x000, 0);
            this.physics.add.existing(this.door2, true);
            this.physics.add.overlap(this.player, this.door2, () => showNotice(this, "Нам сейчас не сюда"));

            // Зона возврата на ламинате (слева)
            this.triggerBack = this.add.rectangle(50, 600, 100, 200, 0x000, 0);
            this.physics.add.existing(this.triggerBack, true);
            this.physics.add.overlap(this.player, this.triggerBack, () => this.scene.start('MainScene', { fromStudio: true }));
        }
        update() { this.updateHero(); }
    }

    const config = {
        type: Phaser.AUTO,
        scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH, width: 1080, height: 1920 },
        physics: { default: 'arcade', arcade: { debug: false } }, // Включи debug: true, чтобы увидеть зоны
        scene: [MainScene, StudioScene]
    };
    new Phaser.Game(config);
</script>
</body>
</html>