<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Supreme Visualizer</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #03050c;
      --cyan: #00f0ff;
      --purple: #c300ff;
      --glow-cyan: rgba(0,240,255,0.8);
      --glow-purple: rgba(195,0,255,0.7);
    }
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: var(--bg);
      font-family: system-ui, -apple-system, sans-serif;
      color: #e0f8ff;
    }
    canvas { display: block; }
    #controls {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 30;
      background: rgba(0,0,0,0.6);
      padding: 16px 36px;
      border-radius: 50px;
      backdrop-filter: blur(16px);
      border: 1px solid rgba(0,240,255,0.4);
      box-shadow: 0 0 40px rgba(0,240,255,0.25);
      text-align: center;
    }
    button, label {
      padding: 12px 26px;
      margin: 8px 4px;
      font-size: 1.1rem;
      background: rgba(0,240,255,0.18);
      border: 1px solid var(--cyan);
      color: white;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.3s;
      text-shadow: 0 0 8px var(--glow-cyan);
    }
    button:hover, label:hover {
      background: rgba(0,240,255,0.4);
      box-shadow: 0 0 30px var(--glow-cyan);
      transform: scale(1.05);
    }
    input[type="file"] { display: none; }
    #status {
      margin-top: 14px;
      font-size: 1.05rem;
      text-shadow: 0 0 12px rgba(0,240,255,0.6);
      max-width: 320px;
    }
    .shake {
      animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
    }
    @keyframes shake {
      10%, 90% { transform: translate3d(-2px, 0, 0); }
      20%, 80% { transform: translate3d(4px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
      40%, 60% { transform: translate3d(6px, 0, 0); }
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <div id="controls">
    <label for="audioFile">Load Beat</label>
    <input type="file" id="audioFile" accept="audio/*" />
    <button id="micBtn">Live Mic</button>
    <button id="pauseBtn" disabled>Pause</button>
    <div id="status">Drop a track or tap Live Mic to swing</div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const status = document.getElementById('status');
    const pauseBtn = document.getElementById('pauseBtn');

    let audioCtx = null;
    let analyser = null;
    let source = null;
    let dataArray = null;
    let freqData = null;
    let particles = [];
    let smokeTrails = [];
    let audioElement = new Audio();
    let isPlaying = false;
    let lastBass = 0;
    let shakeIntensity = 0;

    // Advanced Particle with trails
    class Particle {
      constructor() {
        this.reset();
      }
      reset() {
        this.x = canvas.width / 2;
        this.y = canvas.height / 2;
        this.size = Math.random() * 7 + 3;
        this.speedX = Math.random() * 12 - 6;
        this.speedY = Math.random() * 12 - 6;
        this.life = 1.4;
        this.hue = 180 + Math.random() * 140;
        this.trail = [];
      }
      update(bass, mid, high) {
        this.trail.push({x: this.x, y: this.y, life: this.life});
        if (this.trail.length > 25) this.trail.shift();

        this.x += this.speedX * (1 + bass / 45);
        this.y += this.speedY * (1 + mid / 65);
        this.life -= 0.014 + high / 4500;
        if (this.life <= 0) this.reset();
        this.hue = 180 + high * 1.8;
      }
      draw() {
        // Smoke trail
        for (let i = 0; i < this.trail.length; i++) {
          const t = this.trail[i];
          ctx.beginPath();
          ctx.arc(t.x, t.y, this.size * t.life * 0.8, 0, Math.PI*2);
          ctx.fillStyle = `hsla(${this.hue}, 90%, 60%, ${t.life * 0.25})`;
          ctx.fill();
        }

        // Main particle with bloom
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size * this.life * 2.5, 0, Math.PI*2);
        ctx.fillStyle = `hsla(${this.hue}, 100%, 75%, ${this.life * 0.95})`;
        ctx.shadowBlur = 50;
        ctx.shadowColor = `hsla(${this.hue}, 100%, 75%, 0.95)`;
        ctx.fill();
      }
    }

    // Create particles
    for (let i = 0; i < 600; i++) particles.push(new Particle());

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    function draw() {
      requestAnimationFrame(draw);

      // Heavy fade + vignette
      ctx.fillStyle = 'rgba(5,7,15,0.18)';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // Vignette
      const grad = ctx.createRadialGradient(
        canvas.width/2, canvas.height/2, canvas.width*0.3,
        canvas.width/2, canvas.height/2, canvas.width*0.8
      );
      grad.addColorStop(0, 'rgba(0,0,0,0)');
      grad.addColorStop(1, 'rgba(0,0,0,0.7)');
      ctx.fillStyle = grad;
      ctx.fillRect(0,0,canvas.width,canvas.height);

      if (!analyser || !isPlaying) return;

      analyser.getByteTimeDomainData(dataArray);
      analyser.getByteFrequencyData(freqData);

      const bass = freqData.slice(0, 40).reduce((a,b)=>a+b,0) / 40;
      const mid  = freqData.slice(40, 180).reduce((a,b)=>a+b,0) / 140;
      const high = freqData.slice(180).reduce((a,b)=>a+b,0) / (freqData.length - 180);

      // Beat detection + explosion + shake
      const beatDelta = bass - lastBass;
      if (bass > 140 && beatDelta > 50) {
        shakeIntensity = 12;
        for (let i = 0; i < 40; i++) {
          const p = particles[Math.floor(Math.random() * particles.length)];
          p.reset();
          p.speedX *= 3 + bass / 70;
          p.speedY *= 3 + bass / 70;
          p.hue = 180 + high * 2;
        }
        // Flash
        ctx.fillStyle = 'rgba(0,240,255,0.12)';
        ctx.fillRect(0,0,canvas.width,canvas.height);
      }
      lastBass = bass;

      // Apply shake
      if (shakeIntensity > 0) {
        const shakeX = (Math.random() - 0.5) * shakeIntensity;
        const shakeY = (Math.random() - 0.5) * shakeIntensity;
        ctx.save();
        ctx.translate(shakeX, shakeY);
        shakeIntensity *= 0.75;
      }

      // Central waveform with distortion
      ctx.beginPath();
      ctx.lineWidth = 10 + bass / 25;
      ctx.strokeStyle = `rgba(0,240,255,${0.75 + bass/180})`;
      const sliceWidth = canvas.width / dataArray.length;
      let x = 0;
      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] / 128.0;
        const distort = mid / 80 + high / 200;
        const y = canvas.height / 2 + (v - 1) * (canvas.height / 2) * (1 + distort);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
        x += sliceWidth;
      }
      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.stroke();

      // Particles
      particles.forEach(p => {
        p.update(bass, mid, high);
        p.draw();
      });

      // Double pulsing orbs
      const vol = freqData.reduce((a,b)=>a+b,0) / freqData.length;
      // Inner cyan
      ctx.beginPath();
      ctx.arc(canvas.width/2, canvas.height/2, 90 + vol * 0.7 + bass * 0.5, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(0,240,255,0.22)';
      ctx.shadowBlur = 140;
      ctx.shadowColor = 'rgba(0,240,255,1)';
      ctx.fill();

      // Outer purple
      ctx.beginPath();
      ctx.arc(canvas.width/2, canvas.height/2, 140 + mid * 0.8 + high * 0.6, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(195,0,255,0.12)';
      ctx.shadowBlur = 180;
      ctx.shadowColor = 'rgba(195,0,255,0.9)';
      ctx.fill();

      if (shakeIntensity > 0) ctx.restore();
    }
    draw();

    // File upload
    document.getElementById('audioFile').onchange = e => {
      const file = e.target.files?.[0];
      if (!file) return;
      status.textContent = 'Loading beat...';
      audioElement.src = URL.createObjectURL(file);
      audioElement.onloadedmetadata = () => {
        status.textContent = 'Ready — tap screen if silent';
        startAudio();
        pauseBtn.disabled = false;
      };
      audioElement.onerror = () => status.textContent = 'Cannot play — try smaller MP3';
    };

    // Mic
    document.getElementById('micBtn').onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioElement.srcObject = stream;
        audioElement.onloadedmetadata = () => {
          audioElement.play().catch(() => status.textContent = 'Tap to start mic');
          startAudio();
          status.textContent = 'Mic live — drop the energy!';
          pauseBtn.disabled = false;
        };
      } catch (err) {
        status.textContent = 'Mic access blocked';
      }
    };

    async function startAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === 'suspended') {
        await audioCtx.resume();
      }

      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      freqData = new Uint8Array(analyser.frequencyBinCount);

      if (!source) {
        source = audioCtx.createMediaElementSource(audioElement);
        source.connect(analyser);
        analyser.connect(audioCtx.destination);
      }

      isPlaying = true;
      audioElement.play().catch(() => {
        status.textContent = 'Tap anywhere to unlock audio';
      });
    }

    pauseBtn.onclick = () => {
      if (isPlaying) {
        audioElement.pause();
        pauseBtn.textContent = 'Resume';
        status.textContent = 'Paused';
      } else {
        audioElement.play().catch(() => {});
        pauseBtn.textContent = 'Pause';
        status.textContent = 'Back in the mix';
      }
      isPlaying = !isPlaying;
    };

    // Tap to resume audio context
    document.addEventListener('touchstart', async () => {
      if (audioCtx && audioCtx.state === 'suspended') {
        await audioCtx.resume();
        status.textContent = 'Audio unlocked — feel the swing';
      }
    }, { once: true });

    console.log('Supreme Visualizer v2 — ready to swing');
  </script>
</body>
</html>