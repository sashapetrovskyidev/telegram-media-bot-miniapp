<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Studio</title>

<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>

<style>
    body {
        margin: 0;
        background: #111;
        overflow: hidden;
    }
    canvas { display: block; }
</style>
</head>

<body>

<script>
/* =========================================================
   SHARED HELPERS
========================================================= */

function createWalkableDebug(scene, polygon) {
    const g = scene.add.graphics();
    g.lineStyle(4, 0xff0000, 1);
    g.strokePoints(polygon.points, true);
}

/* =========================================================
   BASE ROOM SCENE (REUSABLE)
========================================================= */

class BaseRoom extends Phaser.Scene {
    constructor(key, bgKey, polygonPoints, spawn) {
        super(key);
        this.bgKey = bgKey;
        this.polygonPoints = polygonPoints;
        this.spawn = spawn;
    }

    preload() {
        this.load.image(this.bgKey, `${this.bgKey}.png`);
        this.load.spritesheet('player', 'person_model.png', {
            frameWidth: 64,
            frameHeight: 64
        });
    }

    create() {
        const { width, height } = this.scale;

        // Background
        const bg = this.add.image(0, 0, this.bgKey).setOrigin(0);
        const scale = Math.max(width / bg.width, height / bg.height);
        bg.setScale(scale);

        this.roomWidth = bg.width * scale;
        this.roomHeight = bg.height * scale;

        this.physics.world.setBounds(0, 0, this.roomWidth, this.roomHeight);

        // Walkable polygon (SCALED)
        this.walkable = new Phaser.Geom.Polygon(
            this.polygonPoints.map(p => [
                p[0] * this.roomWidth,
                p[1] * this.roomHeight
            ]).flat()
        );

        // Debug (comment out when done)
        createWalkableDebug(this, this.walkable);

        // Player
        this.player = this.physics.add.sprite(
            this.spawn[0] * this.roomWidth,
            this.spawn[1] * this.roomHeight,
            'player'
        );

        this.player.setScale(3);
        this.player.setCollideWorldBounds(true);
        this.player.body.setSize(32, 24);
        this.player.body.setOffset(16, 36);

        // Animations
        if (!this.anims.exists('walk-down')) {
            this.anims.create({ key: 'walk-down', frames: this.anims.generateFrameNumbers('player', { start: 0, end: 3 }), frameRate: 10, repeat: -1 });
            this.anims.create({ key: 'walk-left', frames: this.anims.generateFrameNumbers('player', { start: 4, end: 7 }), frameRate: 10, repeat: -1 });
            this.anims.create({ key: 'walk-right', frames: this.anims.generateFrameNumbers('player', { start: 8, end: 11 }), frameRate: 10, repeat: -1 });
            this.anims.create({ key: 'walk-up', frames: this.anims.generateFrameNumbers('player', { start: 12, end: 15 }), frameRate: 10, repeat: -1 });
            this.anims.create({ key: 'idle-down', frames: [{ key: 'player', frame: 1 }] });
            this.anims.create({ key: 'idle-left', frames: [{ key: 'player', frame: 5 }] });
            this.anims.create({ key: 'idle-right', frames: [{ key: 'player', frame: 9 }] });
            this.anims.create({ key: 'idle-up', frames: [{ key: 'player', frame: 13 }] });
        }

        this.playerDirection = 'down';
        this.player.anims.play('idle-down');

        // Camera
        this.cameras.main.startFollow(this.player, true, 0.1, 0.1);
        this.cameras.main.setBounds(0, 0, this.roomWidth, this.roomHeight);
        this.cameras.main.setZoom(1.4);
        this.cameras.main.fadeIn(800);

        // Movement
        this.target = null;

        this.input.on('pointerdown', pointer => {
            const world = this.cameras.main.getWorldPoint(pointer.x, pointer.y);

            if (Phaser.Geom.Polygon.Contains(this.walkable, world.x, world.y)) {
                this.target = world;
                this.physics.moveTo(this.player, world.x, world.y, 250);
            }
        });
    }

    update() {
        const v = this.player.body.velocity.length();

        if (v > 10) {
            const a = Phaser.Math.RadToDeg(Math.atan2(this.player.body.velocity.y, this.player.body.velocity.x));
            if (a > -45 && a <= 45) this.player.anims.play('walk-right', true), this.playerDirection = 'right';
            else if (a > 45 && a <= 135) this.player.anims.play('walk-down', true), this.playerDirection = 'down';
            else if (a > 135 || a <= -135) this.player.anims.play('walk-left', true), this.playerDirection = 'left';
            else this.player.anims.play('walk-up', true), this.playerDirection = 'up';
        } else {
            this.player.anims.play('idle-' + this.playerDirection, true);
        }

        // Stop outside floor
        if (!Phaser.Geom.Polygon.Contains(this.walkable, this.player.x, this.player.y)) {
            this.player.body.setVelocity(0);
        }

        if (this.target) {
            const d = Phaser.Math.Distance.Between(this.player.x, this.player.y, this.target.x, this.target.y);
            if (d < 8) {
                this.player.body.setVelocity(0);
                this.target = null;
            }
        }
    }
}

/* =========================================================
   LIVING ROOM
========================================================= */

class LivingRoom extends BaseRoom {
    constructor() {
        super(
            'LivingRoom',
            'room1',
            [
                [0.08, 0.90],
                [0.08, 0.40],
                [0.55, 0.40],
                [0.55, 0.55],
                [0.35, 0.55],
                [0.35, 0.75],
                [0.90, 0.75],
                [0.90, 0.90]
            ],
            [0.40, 0.75]
        );
    }
}

/* =========================================================
   STUDIO
========================================================= */

class StudioRoom extends BaseRoom {
    constructor() {
        super(
            'StudioRoom',
            'room2',
            [
                [0.05, 0.90],
                [0.05, 0.35],
                [0.45, 0.35],
                [0.45, 0.60],
                [0.30, 0.60],
                [0.30, 0.80],
                [0.90, 0.80],
                [0.90, 0.90]
            ],
            [0.35, 0.75]
        );
    }
}

/* =========================================================
   GAME CONFIG
========================================================= */

new Phaser.Game({
    type: Phaser.AUTO,
    width: 1080,
    height: 1920,
    physics: {
        default: 'arcade',
        arcade: { gravity: { y: 0 }, debug: false }
    },
    scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH
    },
    scene: [LivingRoom, StudioRoom]
});
</script>

</body>
</html>
