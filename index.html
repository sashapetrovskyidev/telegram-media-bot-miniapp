<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Studio - Real Logic</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; }
        canvas { display: block; }
    </style>
</head>
<body>
<script>
    let popup;

    // Функция для всплывающего уведомления (надписи)
    function showMsg(scene, text) {
        if (popup) popup.destroy();
        // Привязываем текст к камере, чтобы он всегда был по центру экрана
        popup = scene.add.text(540, 500, text, {
            fontSize: '48px', fill: '#fff', backgroundColor: '#e74c3c', padding: { x: 20, y: 10 }
        }).setOrigin(0.5).setDepth(2000).setScrollFactor(0);
        
        scene.time.delayedCall(2000, () => { if (popup) popup.destroy(); });
    }

    // --- БАЗОВЫЙ КЛАСС КОМНАТЫ ---
    class BaseRoom extends Phaser.Scene {
        constructor(key) { super(key); }

        initRoom(bgKey, spawnX, spawnY) {
            // Загружаем фон в оригинальном размере
            const bg = this.add.image(0, 0, bgKey).setOrigin(0, 0);
            
            // Границы мира равны размеру картинки
            this.physics.world.setBounds(0, 0, bg.width, bg.height);
            
            // Персонаж (нарезанный спрайт)
            this.player = this.physics.add.sprite(spawnX, spawnY, 'player');
            this.player.setScale(2).setCollideWorldBounds(true);
            this.playerDirection = 'down';

            // Настройка камеры
            this.cameras.main.setBounds(0, 0, bg.width, bg.height);
            this.cameras.main.startFollow(this.player, true, 0.1, 0.1);

            // Анимации (4x4)
            if (!this.anims.exists('walk-down')) {
                const directions = ['down', 'left', 'right', 'up'];
                directions.forEach((dir, i) => {
                    this.anims.create({
                        key: `walk-${dir}`,
                        frames: this.anims.generateFrameNumbers('player', { start: i * 4, end: i * 4 + 3 }),
                        frameRate: 10, repeat: -1
                    });
                    this.anims.create({ key: `idle-${dir}`, frames: [{ key: 'player', frame: i * 4 }], frameRate: 1 });
                });
            }

            this.input.on('pointerdown', (p) => {
                this.targetX = p.worldX;
                this.targetY = p.worldY;
                this.physics.moveTo(this.player, this.targetX, this.targetY, 400);
            });
        }

        updateLogic() {
            if (!this.player.body) return;
            const vel = this.player.body.velocity;

            if (vel.x !== 0 || vel.y !== 0) {
                const deg = Phaser.Math.RadToDeg(Math.atan2(vel.y, vel.x));
                if (deg > -45 && deg <= 45) { this.player.anims.play('walk-right', true); this.playerDirection = 'right'; }
                else if (deg > 45 && deg <= 135) { this.player.anims.play('walk-down', true); this.playerDirection = 'down'; }
                else if (deg > 135 || deg <= -135) { this.player.anims.play('walk-left', true); this.playerDirection = 'left'; }
                else { this.player.anims.play('walk-up', true); this.playerDirection = 'up'; }
            } else {
                this.player.anims.play('idle-' + this.playerDirection, true);
            }

            if (this.targetX && Phaser.Math.Distance.Between(this.player.x, this.player.y, this.targetX, this.targetY) < 15) {
                this.player.body.reset(this.player.x, this.player.y);
                this.targetX = null;
            }
        }
    }

    // --- ГОСТИНАЯ (ЗОНА 1) ---
    class MainScene extends BaseRoom {
        constructor() { super('MainScene'); }
        preload() {
            this.load.image('room1', 'room1.png');
            this.load.spritesheet('player', 'person_model.png', { frameWidth: 64, frameHeight: 64 });
        }
        create() {
            const spawnX = this.scene.settings.data.fromStudio ? 1000 : 400;
            this.initRoom('room1', spawnX, 1500);

            // ДВЕРЬ (только текст)
            this.door = this.add.rectangle(150, 1000, 200, 400, 0x000, 0);
            this.physics.add.existing(this.door, true);
            this.physics.add.overlap(this.player, this.door, () => showMsg(this, "Нам сейчас не сюда"));

            // ПЕРЕХОД НА ЛАМИНАТЕ (справа внизу)
            const bgWidth = this.textures.get('room1').getSourceImage().width;
            this.trigger = this.add.rectangle(bgWidth - 50, 1600, 100, 400, 0x000, 0);
            this.physics.add.existing(this.trigger, true);
            this.physics.add.overlap(this.player, this.trigger, () => this.scene.start('StudioScene', { fromMain: true }));
        }
        update() { this.updateLogic(); }
    }

    // --- СТУДИЯ (ЗОНА 2) ---
    class StudioScene extends BaseRoom {
        constructor() { super('StudioScene'); }
        preload() { this.load.image('room2', 'room2.png'); }
        create() {
            this.initRoom('room2', 150, 1600); // Появляемся на ламинате слева

            // ДВЕРЬ (только текст)
            this.door2 = this.add.rectangle(950, 1000, 200, 400, 0x000, 0);
            this.physics.add.existing(this.door2, true);
            this.physics.add.overlap(this.player, this.door2, () => showMsg(this, "Нам сейчас не сюда"));

            // ВОЗВРАТ НА ЛАМИНАТЕ (слева внизу)
            this.triggerBack = this.add.rectangle(10, 1600, 100, 400, 0x000, 0);
            this.physics.add.existing(this.triggerBack, true);
            this.physics.add.overlap(this.player, this.triggerBack, () => this.scene.start('MainScene', { fromStudio: true }));
        }
        update() { this.updateLogic(); }
    }

    // --- КОНФИГ ДЛЯ ТЕЛЕГРАМА ---
    const config = {
        type: Phaser.AUTO,
        scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH, width: 1080, height: 1920 },
        physics: { default: 'arcade', arcade: { debug: false } }, // Поставь true, чтобы увидеть квадраты на полу и дверях
        scene: [MainScene, StudioScene]
    };
    new Phaser.Game(config);
</script>
</body>
</html>
