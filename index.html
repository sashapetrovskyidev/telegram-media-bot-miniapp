<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Studio Game</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; }
        canvas { display: block; }
    </style>
</head>
<body>
<script>
    let popup;

    // Функция только для всплывающего текста на дверях
    function showLockedMessage(scene, text) {
        if (popup) popup.destroy();
        popup = scene.add.text(540, 600, text, {
            fontSize: '52px', fill: '#ffffff', backgroundColor: '#e74c3c', padding: { x: 25, y: 15 }
        }).setOrigin(0.5).setDepth(2000);
        scene.time.delayedCall(2000, () => { if (popup) popup.destroy(); });
    }

    // --- 1. МЕНЮ ---
    class MenuScene extends Phaser.Scene {
        constructor() { super('MenuScene'); }
        preload() { this.load.image('menuBg', 'room1.png'); }
        create() {
            this.add.image(540, 960, 'menuBg').setDisplaySize(1080, 1920).setAlpha(0.4);
            let btn = this.add.text(540, 960, '[ ВОЙТИ В СТУДИЮ ]', { fontSize: '70px', fill: '#00ff00' })
                .setOrigin(0.5).setInteractive();
            btn.on('pointerdown', () => this.scene.start('MainScene'));
        }
    }

    // --- 2. БАЗОВАЯ ЛОГИКА (Анимации и Движение) ---
    class BaseRoom extends Phaser.Scene {
        constructor(key) { super(key); }

        spawnHero(x, y) {
            this.player = this.physics.add.sprite(x, y, 'player');
            this.player.setScale(2.5).setCollideWorldBounds(true);
            this.playerDirection = 'down';
            this.targetX = null;
            this.targetY = null;

            if (!this.anims.exists('walk-down')) {
                const dirs = ['down', 'left', 'right', 'up'];
                dirs.forEach((dir, i) => {
                    this.anims.create({
                        key: `walk-${dir}`,
                        frames: this.anims.generateFrameNumbers('player', { start: i * 4, end: i * 4 + 3 }),
                        frameRate: 10, repeat: -1
                    });
                    this.anims.create({ key: `idle-${dir}`, frames: [{ key: 'player', frame: i * 4 }], frameRate: 1 });
                });
            }

            this.input.on('pointerdown', (p) => {
                this.targetX = p.worldX;
                this.targetY = p.worldY;
                this.physics.moveTo(this.player, this.targetX, this.targetY, 450);
            });
        }

        updateHero() {
            if (!this.player.body) return;
            const vel = this.player.body.velocity;

            if (vel.x !== 0 || vel.y !== 0) {
                const deg = Phaser.Math.RadToDeg(Math.atan2(vel.y, vel.x));
                if (deg > -45 && deg <= 45) { this.player.anims.play('walk-right', true); this.playerDirection = 'right'; }
                else if (deg > 45 && deg <= 135) { this.player.anims.play('walk-down', true); this.playerDirection = 'down'; }
                else if (deg > 135 || deg <= -135) { this.player.anims.play('walk-left', true); this.playerDirection = 'left'; }
                else { this.player.anims.play('walk-up', true); this.playerDirection = 'up'; }
            } else {
                this.player.anims.play('idle-' + this.playerDirection, true);
            }

            if (this.targetX !== null && Phaser.Math.Distance.Between(this.player.x, this.player.y, this.targetX, this.targetY) < 15) {
                this.player.body.reset(this.player.x, this.player.y);
                this.targetX = null;
            }
        }
    }

    // --- 3. ГОСТИНАЯ (ЗОНА 1) ---
    class MainScene extends BaseRoom {
        constructor() { super('MainScene'); }
        preload() {
            this.load.image('bg1', 'room1.png');
            this.load.spritesheet('player', 'person_model.png', { frameWidth: 64, frameHeight: 64 });
        }
        create() {
            this.add.image(540, 960, 'bg1').setDisplaySize(1080, 1920);
            let startX = this.scene.settings.data.fromStudio ? 1000 : 540;
            this.spawnHero(startX, 1500);

            // ДВЕРЬ: только сообщение
            this.door1 = this.add.rectangle(150, 1000, 200, 450, 0x000, 0);
            this.physics.add.existing(this.door1, true);
            this.physics.add.overlap(this.player, this.door1, () => showLockedMessage(this, "Нам сейчас не сюда"));

            // ЛАМИНАТ (Справа): Переход в студию
            this.floorTrigger = this.add.rectangle(1070, 1600, 60, 400, 0x000, 0);
            this.physics.add.existing(this.floorTrigger, true);
            this.physics.add.overlap(this.player, this.floorTrigger, () => {
                this.scene.start('StudioScene', { fromMain: true });
            });
        }
        update() { this.updateHero(); }
    }

    // --- 4. СТУДИЯ (ЗОНА 2) ---
    class StudioScene extends BaseRoom {
        constructor() { super('StudioScene'); }
        preload() { this.load.image('bg2', 'room2.png'); }
        create() {
            this.add.image(540, 960, 'bg2').setDisplaySize(1080, 1920);
            this.spawnHero(80, 1600); // Появляемся на ламинате слева

            // ДВЕРЬ: только сообщение
            this.door2 = this.add.rectangle(950, 1000, 200, 450, 0x000, 0);
            this.physics.add.existing(this.door2, true);
            this.physics.add.overlap(this.player, this.door2, () => showLockedMessage(this, "Нам сейчас не сюда"));

            // ЛАМИНАТ (Слева): Возврат в гостиную
            this.floorBack = this.add.rectangle(10, 1600, 60, 400, 0x000, 0);
            this.physics.add.existing(this.floorBack, true);
            this.physics.add.overlap(this.player, this.floorBack, () => {
                this.scene.start('MainScene', { fromStudio: true });
            });
        }
        update() { this.updateHero(); }
    }

    const config = {
        type: Phaser.AUTO,
        scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH, width: 1080, height: 1920 },
        physics: { default: 'arcade', arcade: { debug: false } },
        scene: [MenuScene, MainScene, StudioScene]
    };
    new Phaser.Game(config);
</script>
</body>
</html>
