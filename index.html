<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Studio</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #1a1a1a; 
            overflow: hidden;
            font-family: 'Courier New', monospace;
        }
        canvas { display: block; }
    </style>
</head>
<body>
<script>
    // --- START MENU SCENE ---
    class MenuScene extends Phaser.Scene {
        constructor() { super('MenuScene'); }

        preload() {
            // Load menu background (studio room preview)
            this.load.image('menuBg', 'room2.jpg');
            
            this.load.on('loaderror', (file) => {
                console.error('Ошибка загрузки: ' + file.key);
            });
        }

        create() {
            const { width, height } = this.scale;

            // Темный оверлей поверх фона студии
            this.add.image(width / 2, height / 2, 'menuBg')
                .setDisplaySize(width, height)
                .setAlpha(0.3);

            // Темный градиент
            const overlay = this.add.graphics();
            overlay.fillGradientStyle(0x0a0a0a, 0x0a0a0a, 0x1a1a2e, 0x1a1a2e, 0.85);
            overlay.fillRect(0, 0, width, height);

            // Рамка меню в стиле пиксель-арт
            const menuBox = this.add.graphics();
            menuBox.lineStyle(8, 0x4a5568, 1);
            menuBox.strokeRect(width / 2 - 380, height / 2 - 250, 760, 500);
            menuBox.lineStyle(4, 0x6b7280, 1);
            menuBox.strokeRect(width / 2 - 390, height / 2 - 260, 780, 520);

            // Фон для рамки
            const menuBg = this.add.graphics();
            menuBg.fillStyle(0x1e293b, 0.95);
            menuBg.fillRect(width / 2 - 380, height / 2 - 250, 760, 500);

            // Заголовок "MY STUDIO"
            const title = this.add.text(width / 2, height / 2 - 150, 'MY STUDIO', {
                fontSize: '96px',
                fontFamily: 'Courier New, monospace',
                color: '#94a3b8',
                fontStyle: 'bold',
                stroke: '#1e293b',
                strokeThickness: 12
            }).setOrigin(0.5);

            // Пульсация заголовка
            this.tweens.add({
                targets: title,
                alpha: { from: 0.8, to: 1 },
                scale: { from: 0.98, to: 1.02 },
                duration: 2000,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });

            // Кнопка START GAME
            const startBtnY = height / 2 + 20;
            this.createPixelButton(
                width / 2, 
                startBtnY, 
                'START GAME',
                () => {
                    this.cameras.main.fadeOut(500, 0, 0, 0);
                    this.time.delayedCall(500, () => {
                        this.scene.start('MainScene');
                    });
                }
            );

            // Кнопка OPTIONS
            const optionsBtnY = height / 2 + 130;
            this.createPixelButton(
                width / 2, 
                optionsBtnY, 
                'OPTIONS',
                () => {
                    // Пока просто анимация
                    this.cameras.main.shake(200, 0.002);
                }
            );

            // Подсказка внизу
            const hint = this.add.text(width / 2, height - 120, 'Нажмите на экран для движения', {
                fontSize: '28px',
                fontFamily: 'Courier New',
                color: '#64748b',
                alpha: 0.7
            }).setOrigin(0.5);

            // Мигание подсказки
            this.tweens.add({
                targets: hint,
                alpha: { from: 0.4, to: 0.9 },
                duration: 1500,
                yoyo: true,
                repeat: -1
            });

            // Появление меню
            this.cameras.main.fadeIn(800, 10, 10, 30);
        }

        createPixelButton(x, y, text, callback) {
            const btnWidth = 500;
            const btnHeight = 90;

            // Внешняя рамка
            const outerBorder = this.add.graphics();
            outerBorder.lineStyle(6, 0x64748b, 1);
            outerBorder.strokeRect(x - btnWidth/2, y - btnHeight/2, btnWidth, btnHeight);

            // Внутренняя рамка
            const innerBorder = this.add.graphics();
            innerBorder.lineStyle(3, 0x475569, 1);
            innerBorder.strokeRect(x - btnWidth/2 + 8, y - btnHeight/2 + 8, btnWidth - 16, btnHeight - 16);

            // Фон кнопки
            const buttonBg = this.add.rectangle(x, y, btnWidth - 16, btnHeight - 16, 0x334155)
                .setInteractive({ useHandCursor: true });

            // Текст кнопки
            const buttonText = this.add.text(x, y, text, {
                fontSize: '42px',
                fontFamily: 'Courier New',
                color: '#cbd5e1',
                fontStyle: 'bold'
            }).setOrigin(0.5);

            // Группа элементов кнопки
            const buttonGroup = [outerBorder, innerBorder, buttonBg, buttonText];

            // Эффекты
            buttonBg.on('pointerover', () => {
                buttonBg.setFillStyle(0x475569);
                buttonText.setColor('#f1f5f9');
                this.tweens.add({
                    targets: buttonGroup,
                    scale: 1.05,
                    duration: 150
                });
            });

            buttonBg.on('pointerout', () => {
                buttonBg.setFillStyle(0x334155);
                buttonText.setColor('#cbd5e1');
                this.tweens.add({
                    targets: buttonGroup,
                    scale: 1.0,
                    duration: 150
                });
            });

            buttonBg.on('pointerdown', () => {
                this.tweens.add({
                    targets: buttonGroup,
                    scale: 0.95,
                    duration: 100,
                    yoyo: true,
                    onComplete: callback
                });
            });
        }
    }

    // --- ГЛАВНАЯ СЦЕНА (ГОСТИНАЯ) ---
    class MainScene extends Phaser.Scene {
        constructor() { super('MainScene'); }

        preload() {
            this.load.image('room1', 'room1.jpg');
            this.load.spritesheet('playerSprite', 'person_model.png', {
                frameWidth: 64,  // Ширина одного кадра
                frameHeight: 64  // Высота одного кадра
            });

            this.load.on('loaderror', (file) => {
                console.error('Ошибка загрузки: ' + file.key);
            });
        }

        create() {
            // Фон комнаты
            const bg = this.add.image(0, 0, 'room1').setOrigin(0, 0);
            const roomWidth = bg.width;
            const roomHeight = bg.height;

            // Границы мира
            this.physics.world.setBounds(0, 0, roomWidth, roomHeight);

            // Создание анимаций из спрайтшита
            // Строка 1 (кадры 0-3): вниз
            // Строка 2 (кадры 4-7): влево
            // Строка 3 (кадры 8-11): вправо
            // Строка 4 (кадры 12-15): вверх

            this.anims.create({
                key: 'walk-down',
                frames: this.anims.generateFrameNumbers('playerSprite', { start: 0, end: 3 }),
                frameRate: 8,
                repeat: -1
            });

            this.anims.create({
                key: 'walk-left',
                frames: this.anims.generateFrameNumbers('playerSprite', { start: 4, end: 7 }),
                frameRate: 8,
                repeat: -1
            });

            this.anims.create({
                key: 'walk-right',
                frames: this.anims.generateFrameNumbers('playerSprite', { start: 8, end: 11 }),
                frameRate: 8,
                repeat: -1
            });

            this.anims.create({
                key: 'walk-up',
                frames: this.anims.generateFrameNumbers('playerSprite', { start: 12, end: 15 }),
                frameRate: 8,
                repeat: -1
            });

            this.anims.create({
                key: 'idle-down',
                frames: [{ key: 'playerSprite', frame: 1 }],
                frameRate: 1
            });

            this.anims.create({
                key: 'idle-left',
                frames: [{ key: 'playerSprite', frame: 5 }],
                frameRate: 1
            });

            this.anims.create({
                key: 'idle-right',
                frames: [{ key: 'playerSprite', frame: 9 }],
                frameRate: 1
            });

            this.anims.create({
                key: 'idle-up',
                frames: [{ key: 'playerSprite', frame: 13 }],
                frameRate: 1
            });

            // Персонаж (стартовая позиция в центре нижней части)
            this.player = this.physics.add.sprite(roomWidth / 2, roomHeight - 300, 'playerSprite')
                .setScale(2.5);
            this.player.setCollideWorldBounds(true);
            this.player.body.setSize(40, 30);  // Коллизия меньше спрайта
            this.player.body.setOffset(12, 30); // Смещение коллизии

            // Направление персонажа
            this.playerDirection = 'down';

            // КАМЕРА СЛЕДУЕТ ЗА ИГРОКОМ
            this.cameras.main.startFollow(this.player, true, 0.08, 0.08);
            this.cameras.main.setBounds(0, 0, roomWidth, roomHeight);
            this.cameras.main.setZoom(1);

            // Появление сцены
            this.cameras.main.fadeIn(800, 0, 0, 0);

            // Управление
            this.targetX = null;
            this.targetY = null;

            this.input.on('pointerdown', (pointer) => {
                const worldPoint = this.cameras.main.getWorldPoint(pointer.x, pointer.y);
                this.targetX = worldPoint.x;
                this.targetY = worldPoint.y;
                this.physics.moveToObject(this.player, worldPoint, 200);
            });

            // --- КОЛЛИЗИИ (Препятствия в гостиной) ---
            this.obstacles = this.physics.add.staticGroup();

            // Диван (внизу по центру)
            let sofa = this.add.rectangle(roomWidth / 2, roomHeight - 400, 500, 250, 0x000000, 0);
            this.physics.add.existing(sofa, true);
            this.physics.add.collider(this.player, sofa);

            // Тумба с TV (верхняя часть)
            let tvStand = this.add.rectangle(roomWidth / 2, 350, 400, 200, 0x000000, 0);
            this.physics.add.existing(tvStand, true);
            this.physics.add.collider(this.player, tvStand);

            // --- ЗОНА ПЕРЕХОДА В СТУДИЮ (дверь справа) ---
            this.exitZone = this.add.rectangle(roomWidth - 100, roomHeight / 2, 150, 400, 0x00ff00, 0);
            this.physics.add.existing(this.exitZone, true);

            this.physics.add.overlap(this.player, this.exitZone, () => {
                this.cameras.main.fadeOut(500, 0, 0, 0);
                this.player.body.setVelocity(0, 0);
                this.time.delayedCall(500, () => {
                    this.scene.start('StudioScene');
                });
            }, null, this);

            // Debug (раскомментируй для отладки коллизий)
            // this.exitZone.setAlpha(0.3);
        }

        update() {
            const speed = this.player.body.velocity.length();

            if (speed > 10) {
                // Определяем направление движения
                const angle = Math.atan2(this.player.body.velocity.y, this.player.body.velocity.x);
                const deg = Phaser.Math.RadToDeg(angle);

                if (deg > -45 && deg <= 45) {
                    this.player.anims.play('walk-right', true);
                    this.playerDirection = 'right';
                } else if (deg > 45 && deg <= 135) {
                    this.player.anims.play('walk-down', true);
                    this.playerDirection = 'down';
                } else if (deg > 135 || deg <= -135) {
                    this.player.anims.play('walk-left', true);
                    this.playerDirection = 'left';
                } else {
                    this.player.anims.play('walk-up', true);
                    this.playerDirection = 'up';
                }
            } else {
                // Стоп-анимация
                this.player.anims.play('idle-' + this.playerDirection, true);
            }

            // Остановка у цели
            if (this.targetX !== null && this.targetY !== null) {
                const distance = Phaser.Math.Distance.Between(
                    this.player.x, this.player.y, 
                    this.targetX, this.targetY
                );

                if (distance < 10) {
                    this.player.body.setVelocity(0, 0);
                    this.targetX = null;
                    this.targetY = null;
                }
            }
        }
    }

    // --- СТУДИЯ ---
    class StudioScene extends Phaser.Scene {
        constructor() { super('StudioScene'); }

        preload() {
            this.load.image('room2', 'room2.jpg');
        }

        create() {
            const bg = this.add.image(0, 0, 'room2').setOrigin(0, 0);
            const roomWidth = bg.width;
            const roomHeight = bg.height;

            this.physics.world.setBounds(0, 0, roomWidth, roomHeight);

            // Персонаж появляется у левой двери
            this.player = this.physics.add.sprite(250, roomHeight / 2, 'playerSprite')
                .setScale(2.5);
            this.player.setCollideWorldBounds(true);
            this.player.body.setSize(40, 30);
            this.player.body.setOffset(12, 30);

            this.playerDirection = 'down';

            // КАМЕРА
            this.cameras.main.startFollow(this.player, true, 0.08, 0.08);
            this.cameras.main.setBounds(0, 0, roomWidth, roomHeight);
            this.cameras.main.fadeIn(800, 0, 0, 0);

            this.targetX = null;
            this.targetY = null;

            this.input.on('pointerdown', (pointer) => {
                const worldPoint = this.cameras.main.getWorldPoint(pointer.x, pointer.y);
                this.targetX = worldPoint.x;
                this.targetY = worldPoint.y;
                this.physics.moveToObject(this.player, worldPoint, 200);
            });

            // --- КОЛЛИЗИИ В СТУДИИ ---
            // Рабочий стол слева
            let desk = this.add.rectangle(350, 450, 400, 200, 0x000000, 0);
            this.physics.add.existing(desk, true);
            this.physics.add.collider(this.player, desk);

            // Диван справа внизу
            let couch = this.add.rectangle(roomWidth - 300, roomHeight - 350, 450, 250, 0x000000, 0);
            this.physics.add.existing(couch, true);
            this.physics.add.collider(this.player, couch);

            // Стеллаж
            let shelf = this.add.rectangle(350, 250, 200, 150, 0x000000, 0);
            this.physics.add.existing(shelf, true);
            this.physics.add.collider(this.player, shelf);

            // --- ЗОНА ВОЗВРАТА (дверь слева) ---
            this.backZone = this.add.rectangle(100, roomHeight / 2, 150, 400, 0xff0000, 0);
            this.physics.add.existing(this.backZone, true);

            this.physics.add.overlap(this.player, this.backZone, () => {
                this.cameras.main.fadeOut(500, 0, 0, 0);
                this.player.body.setVelocity(0, 0);
                this.time.delayedCall(500, () => {
                    this.scene.start('MainScene');
                });
            }, null, this);
        }

        update() {
            const speed = this.player.body.velocity.length();

            if (speed > 10) {
                const angle = Math.atan2(this.player.body.velocity.y, this.player.body.velocity.x);
                const deg = Phaser.Math.RadToDeg(angle);

                if (deg > -45 && deg <= 45) {
                    this.player.anims.play('walk-right', true);
                    this.playerDirection = 'right';
                } else if (deg > 45 && deg <= 135) {
                    this.player.anims.play('walk-down', true);
                    this.playerDirection = 'down';
                } else if (deg > 135 || deg <= -135) {
                    this.player.anims.play('walk-left', true);
                    this.playerDirection = 'left';
                } else {
                    this.player.anims.play('walk-up', true);
                    this.playerDirection = 'up';
                }
            } else {
                this.player.anims.play('idle-' + this.playerDirection, true);
            }

            if (this.targetX !== null && this.targetY !== null) {
                const distance = Phaser.Math.Distance.Between(
                    this.player.x, this.player.y, 
                    this.targetX, this.targetY
                );

                if (distance < 10) {
                    this.player.body.setVelocity(0, 0);
                    this.targetX = null;
                    this.targetY = null;
                }
            }
        }
    }

    // --- КОНФИГУРАЦИЯ ИГРЫ ---
    const config = {
        type: Phaser.AUTO,
        scale: {
            mode: Phaser.Scale.FIT,
            autoCenter: Phaser.Scale.CENTER_BOTH,
            width: 1080,
            height: 1920
        },
        physics: {
            default: 'arcade',
            arcade: {
                debug: false, // Измени на true для просмотра коллизий
                gravity: { y: 0 }
            }
        },
        scene: [MenuScene, MainScene, StudioScene]
    };

    const game = new Phaser.Game(config);
</script>
</body>
</html>