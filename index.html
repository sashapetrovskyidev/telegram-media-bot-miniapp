<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Studio</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #1a1a1a; 
            overflow: hidden;
            font-family: 'Courier New', monospace;
        }
        canvas { display: block; }
    </style>
</head>
<body>
<script>
    // --- START MENU SCENE ---
    class MenuScene extends Phaser.Scene {
        constructor() { super('MenuScene'); }

        preload() {
            this.load.image('menuBg', 'room1.png');
            
            this.load.on('loaderror', (file) => {
                console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸: ' + file.key);
            });
        }

        create() {
            const { width, height } = this.scale;

            this.add.image(width / 2, height / 2, 'menuBg')
                .setDisplaySize(width, height)
                .setAlpha(0.3);

            const overlay = this.add.graphics();
            overlay.fillGradientStyle(0x0a0a0a, 0x0a0a0a, 0x1a1a2e, 0x1a1a2e, 0.85);
            overlay.fillRect(0, 0, width, height);

            const menuBox = this.add.graphics();
            menuBox.lineStyle(8, 0x4a5568, 1);
            menuBox.strokeRect(width / 2 - 380, height / 2 - 250, 760, 500);
            menuBox.lineStyle(4, 0x6b7280, 1);
            menuBox.strokeRect(width / 2 - 390, height / 2 - 260, 780, 520);

            const menuBg = this.add.graphics();
            menuBg.fillStyle(0x1e293b, 0.95);
            menuBg.fillRect(width / 2 - 380, height / 2 - 250, 760, 500);

            const title = this.add.text(width / 2, height / 2 - 150, 'MY STUDIO', {
                fontSize: '96px',
                fontFamily: 'Courier New, monospace',
                color: '#94a3b8',
                fontStyle: 'bold',
                stroke: '#1e293b',
                strokeThickness: 12
            }).setOrigin(0.5);

            this.tweens.add({
                targets: title,
                alpha: { from: 0.8, to: 1 },
                scale: { from: 0.98, to: 1.02 },
                duration: 2000,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });

            const startBtnY = height / 2 + 20;
            this.createPixelButton(
                width / 2, 
                startBtnY, 
                'START GAME',
                () => {
                    this.cameras.main.fadeOut(500, 0, 0, 0);
                    this.time.delayedCall(500, () => {
                        this.scene.start('MainScene');
                    });
                }
            );

            const optionsBtnY = height / 2 + 130;
            this.createPixelButton(
                width / 2, 
                optionsBtnY, 
                'OPTIONS',
                () => {
                    this.cameras.main.shake(200, 0.002);
                }
            );

            const hint = this.add.text(width / 2, height - 120, 'ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° ÑÐºÑ€Ð°Ð½ Ð´Ð»Ñ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ', {
                fontSize: '28px',
                fontFamily: 'Courier New',
                color: '#64748b',
                alpha: 0.7
            }).setOrigin(0.5);

            this.tweens.add({
                targets: hint,
                alpha: { from: 0.4, to: 0.9 },
                duration: 1500,
                yoyo: true,
                repeat: -1
            });

            this.cameras.main.fadeIn(800, 10, 10, 30);
        }

        createPixelButton(x, y, text, callback) {
            const btnWidth = 500;
            const btnHeight = 90;

            const outerBorder = this.add.graphics();
            outerBorder.lineStyle(6, 0x64748b, 1);
            outerBorder.strokeRect(x - btnWidth/2, y - btnHeight/2, btnWidth, btnHeight);

            const innerBorder = this.add.graphics();
            innerBorder.lineStyle(3, 0x475569, 1);
            innerBorder.strokeRect(x - btnWidth/2 + 8, y - btnHeight/2 + 8, btnWidth - 16, btnHeight - 16);

            const buttonBg = this.add.rectangle(x, y, btnWidth - 16, btnHeight - 16, 0x334155)
                .setInteractive({ useHandCursor: true });

            const buttonText = this.add.text(x, y, text, {
                fontSize: '42px',
                fontFamily: 'Courier New',
                color: '#cbd5e1',
                fontStyle: 'bold'
            }).setOrigin(0.5);

            const buttonGroup = [outerBorder, innerBorder, buttonBg, buttonText];

            buttonBg.on('pointerover', () => {
                buttonBg.setFillStyle(0x475569);
                buttonText.setColor('#f1f5f9');
                this.tweens.add({
                    targets: buttonGroup,
                    scale: 1.05,
                    duration: 150
                });
            });

            buttonBg.on('pointerout', () => {
                buttonBg.setFillStyle(0x334155);
                buttonText.setColor('#cbd5e1');
                this.tweens.add({
                    targets: buttonGroup,
                    scale: 1.0,
                    duration: 150
                });
            });

            buttonBg.on('pointerdown', () => {
                this.tweens.add({
                    targets: buttonGroup,
                    scale: 0.95,
                    duration: 100,
                    yoyo: true,
                    onComplete: callback
                });
            });
        }
    }

    // --- Ð“Ð›ÐÐ’ÐÐÐ¯ Ð¡Ð¦Ð•ÐÐ (Ð“ÐžÐ¡Ð¢Ð˜ÐÐÐ¯) ---
    class MainScene extends Phaser.Scene {
        constructor() { super('MainScene'); }

        preload() {
            this.load.image('room1', 'room1.png');
            this.load.spritesheet('playerSprite', 'person_model.png', {
                frameWidth: 64,
                frameHeight: 64
            });

            this.load.on('loaderror', (file) => {
                console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð°: ' + file.key);
                console.error('ÐŸÑƒÑ‚ÑŒ:', file.src);
            });
            
            this.load.on('complete', () => {
                console.log('âœ… Ð’ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹');
            });
            
            this.load.on('filecomplete-spritesheet-playerSprite', () => {
                console.log('âœ… Ð¡Ð¿Ñ€Ð°Ð¹Ñ‚ÑˆÐ¸Ñ‚ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð¶Ð° Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½!');
            });
        }

        create() {
            const screenWidth = this.scale.width;
            const screenHeight = this.scale.height;

            const bg = this.add.image(0, 0, 'room1').setOrigin(0, 0);
            
            const scaleX = screenWidth / bg.width;
            const scaleY = screenHeight / bg.height;
            const scale = Math.max(scaleX, scaleY);
            
            bg.setScale(scale);
            
            const roomWidth = bg.width * scale;
            const roomHeight = bg.height * scale;

            this.physics.world.setBounds(0, 0, roomWidth, roomHeight);

            // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸Ð¹
            if (!this.anims.exists('walk-down')) {
                this.anims.create({
                    key: 'walk-down',
                    frames: this.anims.generateFrameNumbers('playerSprite', { start: 0, end: 3 }),
                    frameRate: 10,
                    repeat: -1
                });

                this.anims.create({
                    key: 'walk-left',
                    frames: this.anims.generateFrameNumbers('playerSprite', { start: 4, end: 7 }),
                    frameRate: 10,
                    repeat: -1
                });

                this.anims.create({
                    key: 'walk-right',
                    frames: this.anims.generateFrameNumbers('playerSprite', { start: 8, end: 11 }),
                    frameRate: 10,
                    repeat: -1
                });

                this.anims.create({
                    key: 'walk-up',
                    frames: this.anims.generateFrameNumbers('playerSprite', { start: 12, end: 15 }),
                    frameRate: 10,
                    repeat: -1
                });

                this.anims.create({
                    key: 'idle-down',
                    frames: [{ key: 'playerSprite', frame: 1 }]
                });

                this.anims.create({
                    key: 'idle-left',
                    frames: [{ key: 'playerSprite', frame: 5 }]
                });

                this.anims.create({
                    key: 'idle-right',
                    frames: [{ key: 'playerSprite', frame: 9 }]
                });

                this.anims.create({
                    key: 'idle-up',
                    frames: [{ key: 'playerSprite', frame: 13 }]
                });
            }

            // ÐŸÐµÑ€ÑÐ¾Ð½Ð°Ð¶
            const fromStudio = this.scene.settings.data?.fromStudio;
            
            if (fromStudio) {
                this.player = this.physics.add.sprite(roomWidth * 0.6, roomHeight * 0.65, 'playerSprite');
            } else {
                this.player = this.physics.add.sprite(roomWidth * 0.4, roomHeight * 0.75, 'playerSprite');
            }
            
            this.player.setScale(3);
            this.player.setCollideWorldBounds(true);
            this.player.body.setSize(32, 24);
            this.player.body.setOffset(16, 36);
            this.player.anims.play('idle-down');
            this.playerDirection = 'down';

            // ÐšÐÐœÐ•Ð Ð Ð’Ð¡Ð•Ð“Ð”Ð Ð¡Ð›Ð•Ð”Ð£Ð•Ð¢ Ð—Ð ÐŸÐ•Ð Ð¡ÐžÐÐÐ–Ð•Ðœ + Ð—Ð£Ðœ
            this.cameras.main.startFollow(this.player, true, 0.1, 0.1);
            this.cameras.main.setBounds(0, 0, roomWidth, roomHeight);
            this.cameras.main.setZoom(1.4); // Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð·ÑƒÐ¼
            this.cameras.main.fadeIn(1000, 0, 0, 0);

            this.targetX = null;
            this.targetY = null;
            this.isTransitioning = false;

            this.input.on('pointerdown', (pointer) => {
                if (this.isTransitioning) return;
                
                const worldPoint = this.cameras.main.getWorldPoint(pointer.x, pointer.y);
                this.targetX = worldPoint.x;
                this.targetY = worldPoint.y;
                this.physics.moveToObject(this.player, worldPoint, 250);
            });

            // --- ÐšÐžÐ›Ð›Ð˜Ð—Ð˜Ð˜ (ÐšÐ ÐÐ¡ÐÐ«Ð• Ð—ÐžÐÐ« - Ð“Ð”Ð• ÐÐ•Ð›Ð¬Ð—Ð¯ Ð¥ÐžÐ”Ð˜Ð¢Ð¬) ---
            
            // Ð”Ð¸Ð²Ð°Ð½ (ÑÐ»ÐµÐ²Ð° Ð²Ð½Ð¸Ð·Ñƒ - Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ñ‡ÐµÑ€Ð½Ñ‹Ð¹ Ð´Ð¸Ð²Ð°Ð½)
            let sofa = this.add.rectangle(roomWidth * 0.18, roomHeight * 0.78, 
                500 * scale, 300 * scale, 0xff0000, 0.3);
            this.physics.add.existing(sofa, true);
            this.physics.add.collider(this.player, sofa);

            // Ð¢ÑƒÐ¼Ð±Ð° Ñ TV (Ð²ÐµÑ€Ñ… Ð¿Ð¾ Ñ†ÐµÐ½Ñ‚Ñ€Ñƒ)
            let tvStand = this.add.rectangle(roomWidth * 0.55, roomHeight * 0.38, 
                460 * scale, 240 * scale, 0xff0000, 0.3);
            this.physics.add.existing(tvStand, true);
            this.physics.add.collider(this.player, tvStand);

            // ÐŸÑƒÑ„Ð¸Ðº (Ñ†ÐµÐ½Ñ‚Ñ€ Ð¿Ð¾Ð»Ð° - Ð±ÐµÐ»Ñ‹Ð¹ ÐºÐ²Ð°Ð´Ñ€Ð°Ñ‚Ð½Ñ‹Ð¹)
            let ottoman = this.add.rectangle(roomWidth * 0.36, roomHeight * 0.66, 
                200 * scale, 170 * scale, 0xff0000, 0.3);
            this.physics.add.existing(ottoman, true);
            this.physics.add.collider(this.player, ottoman);

            // Ð›ÐµÐ²Ð°Ñ ÑÑ‚ÐµÐ½Ð° (ÑˆÑ‚Ð¾Ñ€Ð° + Ð³Ð¸Ñ‚Ð°Ñ€Ð° - Ð²ÑÑ Ð»ÐµÐ²Ð°Ñ ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð°)
            let leftWall = this.add.rectangle(roomWidth * 0.08, roomHeight * 0.5, 
                220 * scale, roomHeight, 0xff0000, 0.3);
            this.physics.add.existing(leftWall, true);
            this.physics.add.collider(this.player, leftWall);

            // Ð’ÐµÑ€Ñ…Ð½ÑÑ ÑÑ‚ÐµÐ½Ð° (Ð½Ð°Ð´ TV - Ð²ÑÑ Ð²ÐµÑ€Ñ…Ð½ÑÑ Ð³Ñ€Ð°Ð½Ð¸Ñ†Ð°)
            let topWall = this.add.rectangle(roomWidth * 0.5, roomHeight * 0.13, 
                roomWidth, 260 * scale, 0xff0000, 0.3);
            this.physics.add.existing(topWall, true);
            this.physics.add.collider(this.player, topWall);

            // ÐŸÑ€Ð°Ð²Ð°Ñ Ð³Ñ€Ð°Ð½Ð¸Ñ†Ð° Ñƒ Ð´Ð²ÐµÑ€Ð¸ (Ð²ÐµÑ€Ñ‚Ð¸ÐºÐ°Ð»ÑŒÐ½Ð°Ñ Ð¿Ð¾Ð»Ð¾ÑÐ° ÑÐ¿Ñ€Ð°Ð²Ð°)
            let rightBorder = this.add.rectangle(roomWidth * 0.97, roomHeight * 0.5, 
                100 * scale, roomHeight, 0xff0000, 0.3);
            this.physics.add.existing(rightBorder, true);
            this.physics.add.collider(this.player, rightBorder);

            // ÐÐ¸Ð¶Ð½ÑÑ Ð³Ñ€Ð°Ð½Ð¸Ñ†Ð° ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹
            let bottomWall = this.add.rectangle(roomWidth * 0.5, roomHeight * 0.96, 
                roomWidth, 120 * scale, 0xff0000, 0.3);
            this.physics.add.existing(bottomWall, true);
            this.physics.add.collider(this.player, bottomWall);

            // --- Ð”Ð’Ð•Ð Ð¬ Ð¡ÐŸÐ ÐÐ’Ð (Ð—ÐÐ‘Ð›ÐžÐšÐ˜Ð ÐžÐ’ÐÐÐ) ---
            this.lockedDoorZone = this.add.rectangle(roomWidth * 0.93, roomHeight * 0.45, 
                140, 280 * scale, 0xffffff, 0);
            this.physics.add.existing(this.lockedDoorZone, true);

            this.lockedDoorMessage = this.add.text(roomWidth * 0.75, roomHeight * 0.3, 
                'Ð•Ñ‰Ðµ Ð½Ðµ Ð²Ñ€ÐµÐ¼Ñ', {
                fontSize: '48px',
                fontFamily: 'Courier New',
                color: '#ffffff',
                backgroundColor: '#000000',
                padding: { x: 25, y: 12 },
                alpha: 0
            }).setOrigin(0.5);

            let lockedMessageShown = false;
            this.physics.add.overlap(this.player, this.lockedDoorZone, () => {
                if (!lockedMessageShown) {
                    lockedMessageShown = true;
                    this.tweens.add({
                        targets: this.lockedDoorMessage,
                        alpha: 1,
                        duration: 300
                    });
                    
                    this.time.delayedCall(2500, () => {
                        this.tweens.add({
                            targets: this.lockedDoorMessage,
                            alpha: 0,
                            duration: 300,
                            onComplete: () => {
                                lockedMessageShown = false;
                            }
                        });
                    });
                }
            }, null, this);

            // --- Ð—Ð•Ð›Ð•ÐÐÐ¯ Ð”Ð˜ÐÐ“ÐžÐÐÐ›Ð¬ÐÐÐ¯ Ð›Ð˜ÐÐ˜Ð¯ ÐŸÐ•Ð Ð•Ð¥ÐžÐ”Ð / ---
            // ÐžÑ‚ Ð¿Ñ€Ð°Ð²Ð¾Ð³Ð¾ Ð½Ð¸Ð¶Ð½ÐµÐ³Ð¾ ÑƒÐ³Ð»Ð° Ð¿Ð¾Ð»Ð° Ðº Ð²ÐµÑ€Ñ…Ð½ÐµÐ¼Ñƒ ÑƒÐ³Ð»Ñƒ Ñƒ Ð´Ð²ÐµÑ€Ð¸
            
            const line = new Phaser.Geom.Line(
                roomWidth * 0.56,  // ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð»Ð¸Ð½Ð¸Ð¸ X (Ñ†ÐµÐ½Ñ‚Ñ€ Ð¿Ð¾Ð»Ð°)
                roomHeight * 0.80, // ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð»Ð¸Ð½Ð¸Ð¸ Y (Ð½Ð¸Ð·)
                roomWidth * 0.91,  // ÐšÐ¾Ð½ÐµÑ† Ð»Ð¸Ð½Ð¸Ð¸ X (Ñƒ Ð´Ð²ÐµÑ€Ð¸)
                roomHeight * 0.53  // ÐšÐ¾Ð½ÐµÑ† Ð»Ð¸Ð½Ð¸Ð¸ Y (Ð²ÐµÑ€Ñ…)
            );
            
            // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑÑ‚ÑƒÑŽ Ð´Ð¸Ð°Ð³Ð¾Ð½Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð·Ð¾Ð½Ñƒ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð° - Ð’Ð˜Ð”Ð˜ÐœÐÐ¯
            this.transitionZone = this.add.polygon(
                0, 0,
                [
                    roomWidth * 0.54, roomHeight * 0.80,  // ÐÐ°Ñ‡Ð°Ð»Ð¾ (Ð½Ð¸Ð· ÑÐ»ÐµÐ²Ð°)
                    roomWidth * 0.58, roomHeight * 0.80,  // Ð¢Ð¾Ð»Ñ‰Ð¸Ð½Ð°
                    roomWidth * 0.93, roomHeight * 0.53,  // ÐšÐ¾Ð½ÐµÑ† (Ð²ÐµÑ€Ñ… ÑÐ¿Ñ€Ð°Ð²Ð°)
                    roomWidth * 0.89, roomHeight * 0.53   // Ð¢Ð¾Ð»Ñ‰Ð¸Ð½Ð°
                ],
                0x00ff00, 0.4  // Ð’Ð˜Ð”Ð˜ÐœÐÐ¯ Ñ Ð¿Ñ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ð¾ÑÑ‚ÑŒÑŽ 0.4
            );
            this.physics.add.existing(this.transitionZone, true);

            // Ð’Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð°Ñ Ð»Ð¸Ð½Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸ (Ð·ÐµÐ»ÐµÐ½Ð°Ñ)
            const debugLine = this.add.graphics();
            debugLine.lineStyle(6, 0x00ff00, 1);
            debugLine.strokeLineShape(line);

            let angleChangeTriggered = false;
            this.physics.add.overlap(this.player, this.transitionZone, () => {
                if (!this.isTransitioning && !angleChangeTriggered) {
                    console.log('ðŸŸ¢ ÐŸÐ•Ð Ð•Ð¥ÐžÐ” Ð’ Ð¡Ð¢Ð£Ð”Ð˜Ð®');
                    angleChangeTriggered = true;
                    this.isTransitioning = true;
                    this.player.body.setVelocity(0, 0);
                    
                    this.cameras.main.fadeOut(800, 0, 0, 0);
                    
                    this.time.delayedCall(800, () => {
                        this.scene.start('StudioScene', { fromLiving: true });
                    });
                }
            }, null, this);

            // Debug - Ñ€Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐ¹ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ð¸Ð´ÐµÑ‚ÑŒ Ð·Ð¾Ð½Ñ‹
            debugLine.setAlpha(1); // Ð’ÐºÐ»ÑŽÑ‡Ð¸ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ð¸Ð´ÐµÑ‚ÑŒ Ð»Ð¸Ð½Ð¸ÑŽ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°
            // sofa.setAlpha(0.3);
            // tvStand.setAlpha(0.3);
            // ottoman.setAlpha(0.3);
            // leftWall.setAlpha(0.3);
            // topWall.setAlpha(0.3);
            // this.transitionZone.setAlpha(0.3);
            // this.lockedDoorZone.setAlpha(0.3);
        }

        update() {
            const speed = this.player.body.velocity.length();

            if (speed > 10) {
                const angle = Math.atan2(this.player.body.velocity.y, this.player.body.velocity.x);
                const deg = Phaser.Math.RadToDeg(angle);

                if (deg > -45 && deg <= 45) {
                    this.player.anims.play('walk-right', true);
                    this.playerDirection = 'right';
                } else if (deg > 45 && deg <= 135) {
                    this.player.anims.play('walk-down', true);
                    this.playerDirection = 'down';
                } else if (deg > 135 || deg <= -135) {
                    this.player.anims.play('walk-left', true);
                    this.playerDirection = 'left';
                } else {
                    this.player.anims.play('walk-up', true);
                    this.playerDirection = 'up';
                }
            } else {
                this.player.anims.play('idle-' + this.playerDirection, true);
            }

            if (this.targetX !== null && this.targetY !== null) {
                const distance = Phaser.Math.Distance.Between(
                    this.player.x, this.player.y, 
                    this.targetX, this.targetY
                );

                if (distance < 10) {
                    this.player.body.setVelocity(0, 0);
                    this.targetX = null;
                    this.targetY = null;
                }
            }
        }
    }

    // --- Ð¡Ð¢Ð£Ð”Ð˜Ð¯ ---
    class StudioScene extends Phaser.Scene {
        constructor() { super('StudioScene'); }

        preload() {
            this.load.image('room2', 'room2.png');
        }

        create() {
            const screenWidth = this.scale.width;
            const screenHeight = this.scale.height;

            const bg = this.add.image(0, 0, 'room2').setOrigin(0, 0);
            
            const scaleX = screenWidth / bg.width;
            const scaleY = screenHeight / bg.height;
            const scale = Math.max(scaleX, scaleY);
            
            bg.setScale(scale);
            
            const roomWidth = bg.width * scale;
            const roomHeight = bg.height * scale;

            this.physics.world.setBounds(0, 0, roomWidth, roomHeight);

            // ÐŸÐµÑ€ÑÐ¾Ð½Ð°Ð¶
            const fromLiving = this.scene.settings.data?.fromLiving;
            
            if (fromLiving) {
                this.player = this.physics.add.sprite(roomWidth * 0.35, roomHeight * 0.75, 'playerSprite');
            } else {
                this.player = this.physics.add.sprite(roomWidth * 0.4, roomHeight * 0.7, 'playerSprite');
            }
            
            this.player.setScale(3);
            this.player.setCollideWorldBounds(true);
            this.player.body.setSize(32, 24);
            this.player.body.setOffset(16, 36);
            this.player.anims.play('idle-down');
            this.playerDirection = 'down';

            // ÐšÐÐœÐ•Ð Ð + Ð—Ð£Ðœ
            this.cameras.main.startFollow(this.player, true, 0.1, 0.1);
            this.cameras.main.setBounds(0, 0, roomWidth, roomHeight);
            this.cameras.main.setZoom(1.4); // Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð·ÑƒÐ¼
            this.cameras.main.fadeIn(1000, 0, 0, 0);

            this.targetX = null;
            this.targetY = null;
            this.isTransitioning = false;

            this.input.on('pointerdown', (pointer) => {
                if (this.isTransitioning) return;
                
                const worldPoint = this.cameras.main.getWorldPoint(pointer.x, pointer.y);
                this.targetX = worldPoint.x;
                this.targetY = worldPoint.y;
                this.physics.moveToObject(this.player, worldPoint, 250);
            });

            // --- ÐšÐžÐ›Ð›Ð˜Ð—Ð˜Ð˜ (ÐšÐ ÐÐ¡ÐÐ«Ð• Ð—ÐžÐÐ« - Ð“Ð”Ð• ÐÐ•Ð›Ð¬Ð—Ð¯ Ð¥ÐžÐ”Ð˜Ð¢Ð¬) ---
            
            // Ð Ð°Ð±Ð¾Ñ‡Ð¸Ð¹ ÑÑ‚Ð¾Ð» (ÑÐ»ÐµÐ²Ð° Ð¿Ð¾ Ñ†ÐµÐ½Ñ‚Ñ€Ñƒ - Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ñ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¾Ð¼)
            let desk = this.add.rectangle(roomWidth * 0.23, roomHeight * 0.5, 
                440 * scale, 280 * scale, 0xff0000, 0.3);
            this.physics.add.existing(desk, true);
            this.physics.add.collider(this.player, desk);

            // Ð¡Ñ‚ÑƒÐ» Ð¿ÐµÑ€ÐµÐ´ ÑÑ‚Ð¾Ð»Ð¾Ð¼
            let chair = this.add.rectangle(roomWidth * 0.48, roomHeight * 0.66, 
                180 * scale, 180 * scale, 0xff0000, 0.3);
            this.physics.add.existing(chair, true);
            this.physics.add.collider(this.player, chair);

            // Ð¡Ñ‚ÐµÐ»Ð»Ð°Ð¶ (ÑÐ»ÐµÐ²Ð° Ð²Ð²ÐµÑ€Ñ…Ñƒ Ð·Ð° ÑÑ‚Ð¾Ð»Ð¾Ð¼ - Ð²Ñ‹ÑÐ¾ÐºÐ¸Ð¹)
            let shelf = this.add.rectangle(roomWidth * 0.23, roomHeight * 0.28, 
                320 * scale, 240 * scale, 0xff0000, 0.3);
            this.physics.add.existing(shelf, true);
            this.physics.add.collider(this.player, shelf);

            // Ð”Ð¸Ð²Ð°Ð½ (ÑÐ¿Ñ€Ð°Ð²Ð° Ð²Ð½Ð¸Ð·Ñƒ)
            let couch = this.add.rectangle(roomWidth * 0.8, roomHeight * 0.72, 
                420 * scale, 280 * scale, 0xff0000, 0.3);
            this.physics.add.existing(couch, true);
            this.physics.add.collider(this.player, couch);

            // ÐšÐ»Ð°Ð²Ð¸ÑˆÐ¸ (ÑÐ»ÐµÐ²Ð° Ð²Ð½Ð¸Ð·Ñƒ Ð²Ð¾Ð·Ð»Ðµ Ð´Ð²ÐµÑ€Ð¸)
            let keyboard = this.add.rectangle(roomWidth * 0.08, roomHeight * 0.78, 
                200 * scale, 240 * scale, 0xff0000, 0.3);
            this.physics.add.existing(keyboard, true);
            this.physics.add.collider(this.player, keyboard);

            // Ð Ð°ÑÑ‚ÐµÐ½Ð¸Ðµ (ÑÐ¿Ñ€Ð°Ð²Ð° Ð¿Ð¾ Ñ†ÐµÐ½Ñ‚Ñ€Ñƒ)
            let plant = this.add.rectangle(roomWidth * 0.85, roomHeight * 0.48, 
                130 * scale, 150 * scale, 0xff0000, 0.3);
            this.physics.add.existing(plant, true);
            this.physics.add.collider(this.player, plant);

            // Ð’ÐµÑ€Ñ…Ð½ÑÑ ÑÑ‚ÐµÐ½Ð° (Ð½Ð°Ð´ Ð²ÑÐµÐ¹ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ð¾Ð¹)
            let topWall = this.add.rectangle(roomWidth * 0.5, roomHeight * 0.11, 
                roomWidth, 240 * scale, 0xff0000, 0.3);
            this.physics.add.existing(topWall, true);
            this.physics.add.collider(this.player, topWall);

            // Ð›ÐµÐ²Ð°Ñ ÑÑ‚ÐµÐ½Ð° (Ð´Ð²ÐµÑ€ÑŒ Ð¸ ÑÑ‚ÐµÐ½Ð°)
            let leftWall = this.add.rectangle(roomWidth * 0.02, roomHeight * 0.5, 
                130 * scale, roomHeight, 0xff0000, 0.3);
            this.physics.add.existing(leftWall, true);
            this.physics.add.collider(this.player, leftWall);

            // ÐŸÑ€Ð°Ð²Ð°Ñ ÑÑ‚ÐµÐ½Ð°
            let rightWall = this.add.rectangle(roomWidth * 0.98, roomHeight * 0.5, 
                110 * scale, roomHeight, 0xff0000, 0.3);
            this.physics.add.existing(rightWall, true);
            this.physics.add.collider(this.player, rightWall);

            // ÐÐ¸Ð¶Ð½ÑÑ ÑÑ‚ÐµÐ½Ð°
            let bottomWall = this.add.rectangle(roomWidth * 0.5, roomHeight * 0.96, 
                roomWidth, 120 * scale, 0xff0000, 0.3);
            this.physics.add.existing(bottomWall, true);
            this.physics.add.collider(this.player, bottomWall);

            // --- Ð”Ð’Ð•Ð Ð¬ Ð¡Ð›Ð•Ð’Ð (Ð—ÐÐ‘Ð›ÐžÐšÐ˜Ð ÐžÐ’ÐÐÐ) ---
            this.lockedDoorZone = this.add.rectangle(roomWidth * 0.05, roomHeight * 0.5, 
                120, 280 * scale, 0xffffff, 0);
            this.physics.add.existing(this.lockedDoorZone, true);

            this.lockedDoorMessage = this.add.text(roomWidth * 0.15, roomHeight * 0.35, 
                'Ð•Ñ‰Ðµ Ð½Ðµ Ð²Ñ€ÐµÐ¼Ñ', {
                fontSize: '48px',
                fontFamily: 'Courier New',
                color: '#ffffff',
                backgroundColor: '#000000',
                padding: { x: 25, y: 12 },
                alpha: 0
            }).setOrigin(0.5);

            let lockedMessageShown = false;
            this.physics.add.overlap(this.player, this.lockedDoorZone, () => {
                if (!lockedMessageShown) {
                    lockedMessageShown = true;
                    this.tweens.add({
                        targets: this.lockedDoorMessage,
                        alpha: 1,
                        duration: 300
                    });
                    
                    this.time.delayedCall(2500, () => {
                        this.tweens.add({
                            targets: this.lockedDoorMessage,
                            alpha: 0,
                            duration: 300,
                            onComplete: () => {
                                lockedMessageShown = false;
                            }
                        });
                    });
                }
            }, null, this);

            // --- Ð—Ð•Ð›Ð•ÐÐÐ¯ Ð”Ð˜ÐÐ“ÐžÐÐÐ›Ð¬ÐÐÐ¯ Ð›Ð˜ÐÐ˜Ð¯ ÐŸÐ•Ð Ð•Ð¥ÐžÐ”Ð \ (ÐžÐ‘Ð ÐÐ¢ÐÐÐ¯) ---
            // ÐžÑ‚ Ð¿Ñ€Ð°Ð²Ð¾Ð³Ð¾ Ð½Ð¸Ð¶Ð½ÐµÐ³Ð¾ ÑƒÐ³Ð»Ð° Ðº Ð»ÐµÐ²Ð¾Ð¼Ñƒ Ð²ÐµÑ€Ñ…Ð½ÐµÐ¼Ñƒ ÑƒÐ³Ð»Ñƒ
            
            const line = new Phaser.Geom.Line(
                roomWidth * 0.62, // ÐŸÑ€Ð°Ð²Ð°Ñ Ñ‡Ð°ÑÑ‚ÑŒ X (Ð½Ð°Ñ‡Ð°Ð»Ð¾ ÑÐ½Ð¸Ð·Ñƒ ÑÐ¿Ñ€Ð°Ð²Ð°)
                roomHeight * 0.80, // ÐÐ¸Ð¶Ð½ÑÑ Ñ‡Ð°ÑÑ‚ÑŒ Y
                roomWidth * 0.10, // Ð›ÐµÐ²Ð°Ñ Ñ‡Ð°ÑÑ‚ÑŒ X (ÐºÐ¾Ð½ÐµÑ† ÑÐ²ÐµÑ€Ñ…Ñƒ ÑÐ»ÐµÐ²Ð°)
                roomHeight * 0.50  // Ð’ÐµÑ€Ñ…Ð½ÑÑ Ñ‡Ð°ÑÑ‚ÑŒ Y
            );
            
            // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑÑ‚ÑƒÑŽ Ð´Ð¸Ð°Ð³Ð¾Ð½Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð·Ð¾Ð½Ñƒ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð° - Ð’Ð˜Ð”Ð˜ÐœÐÐ¯
            this.transitionZone = this.add.polygon(
                0, 0,
                [
                    roomWidth * 0.64, roomHeight * 0.80,   // ÐŸÑ€Ð°Ð²Ñ‹Ð¹ Ð½Ð¸Ð· (Ð½Ð°Ñ‡Ð°Ð»Ð¾)
                    roomWidth * 0.60, roomHeight * 0.80,   // Ð¢Ð¾Ð»Ñ‰Ð¸Ð½Ð° Ð»Ð¸Ð½Ð¸Ð¸
                    roomWidth * 0.08, roomHeight * 0.50,   // Ð›ÐµÐ²Ñ‹Ð¹ Ð²ÐµÑ€Ñ… (ÐºÐ¾Ð½ÐµÑ†)
                    roomWidth * 0.12, roomHeight * 0.50    // Ð¢Ð¾Ð»Ñ‰Ð¸Ð½Ð° Ð»Ð¸Ð½Ð¸Ð¸
                ],
                0x00ff00, 0.4  // Ð’Ð˜Ð”Ð˜ÐœÐÐ¯ Ñ Ð¿Ñ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ð¾ÑÑ‚ÑŒÑŽ 0.4
            );
            this.physics.add.existing(this.transitionZone, true);

            // Ð’Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð°Ñ Ð»Ð¸Ð½Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸ (Ð·ÐµÐ»ÐµÐ½Ð°Ñ Ð´Ð»Ñ ÑÑ‚ÑƒÐ´Ð¸Ð¸)
            const debugLine = this.add.graphics();
            debugLine.lineStyle(6, 0x00ff00, 1);
            debugLine.strokeLineShape(line);

            let angleChangeTriggered = false;
            this.physics.add.overlap(this.player, this.transitionZone, () => {
                if (!this.isTransitioning && !angleChangeTriggered) {
                    console.log('ðŸŸ¢ Ð’ÐžÐ—Ð’Ð ÐÐ¢ Ð’ Ð“ÐžÐ¡Ð¢Ð˜ÐÐ£Ð®');
                    angleChangeTriggered = true;
                    this.isTransitioning = true;
                    this.player.body.setVelocity(0, 0);
                    
                    this.cameras.main.fadeOut(800, 0, 0, 0);
                    
                    this.time.delayedCall(800, () => {
                        this.scene.start('MainScene', { fromStudio: true });
                    });
                }
            }, null, this);

            // ðŸ”´ ÐšÐ ÐÐ¡ÐÐ«Ð• Ð—ÐžÐÐ« = Ð³Ð´Ðµ Ð½ÐµÐ»ÑŒÐ·Ñ Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ (Ð²Ð¸Ð´Ð½Ñ‹ Ñ Ð¿Ñ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ð¾ÑÑ‚ÑŒÑŽ 0.3)
            // ðŸŸ¢ Ð—Ð•Ð›Ð•ÐÐÐ¯ Ð—ÐžÐÐ = Ð»Ð¸Ð½Ð¸Ñ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð° Ð² Ð³Ð¾ÑÑ‚Ð¸Ð½ÑƒÑŽ (Ð²Ð¸Ð´Ð½Ð° Ñ Ð¿Ñ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ð¾ÑÑ‚ÑŒÑŽ 0.4)
        }

        update() {
            const speed = this.player.body.velocity.length();

            if (speed > 10) {
                const angle = Math.atan2(this.player.body.velocity.y, this.player.body.velocity.x);
                const deg = Phaser.Math.RadToDeg(angle);

                if (deg > -45 && deg <= 45) {
                    this.player.anims.play('walk-right', true);
                    this.playerDirection = 'right';
                } else if (deg > 45 && deg <= 135) {
                    this.player.anims.play('walk-down', true);
                    this.playerDirection = 'down';
                } else if (deg > 135 || deg <= -135) {
                    this.player.anims.play('walk-left', true);
                    this.playerDirection = 'left';
                } else {
                    this.player.anims.play('walk-up', true);
                    this.playerDirection = 'up';
                }
            } else {
                this.player.anims.play('idle-' + this.playerDirection, true);
            }

            if (this.targetX !== null && this.targetY !== null) {
                const distance = Phaser.Math.Distance.Between(
                    this.player.x, this.player.y, 
                    this.targetX, this.targetY
                );

                if (distance < 10) {
                    this.player.body.setVelocity(0, 0);
                    this.targetX = null;
                    this.targetY = null;
                }
            }
        }
    }

    // --- ÐšÐžÐÐ¤Ð˜Ð“Ð£Ð ÐÐ¦Ð˜Ð¯ ---
    const config = {
        type: Phaser.AUTO,
        scale: {
            mode: Phaser.Scale.FIT,
            autoCenter: Phaser.Scale.CENTER_BOTH,
            width: 1080,
            height: 1920
        },
        physics: {
            default: 'arcade',
            arcade: {
                debug: false,
                gravity: { y: 0 }
            }
        },
        scene: [MenuScene, MainScene, StudioScene]
    };

    const game = new Phaser.Game(config);
</script>
</body>
</html>